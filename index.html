<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Birthday Portal</title>
    <style>
        body { background: #0d0d0d; color: #ffffff; font-family: sans-serif; text-align: center; padding: 15px; }
        .card { background: #1a1a1a; padding: 20px; border-radius: 10px; border: 1px solid #333; margin: 15px auto; max-width: 400px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        input, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 5px; border: 1px solid #444; background: #262626; color: #fff; box-sizing: border-box; }
        button { background: #1a73e8; color: white; border: none; padding: 12px; width: 100%; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .status-box { padding: 10px; margin-bottom: 15px; border-radius: 5px; background: #222; font-size: 14px; }
        .admin-item { background: #222; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: left; border: 1px solid #444; }
        #birthdayPage, #adminPage { display: none; }
    </style>
</head>
<body>

    <div id="loginSection" class="card">
        <h2>Access Portal</h2>
        <input type="text" id="userCode" placeholder="Enter Code">
        <button onclick="checkCode()">Unlock</button>
    </div>

    <div id="birthdayPage" class="card">
        <h1 style="color:#4caf50;">Happy Birthday!</h1>
        <h2 id="dispName"></h2>
        <p id="dispMsg"></p>
        <button onclick="location.reload()" style="background:#333;">Exit</button>
    </div>

    <div id="adminPage" class="card" style="max-width: 500px;">
        <h2>Admin Dashboard</h2>
        <div class="status-box">
            Hardware Status: <span id="statusText" style="color: gray;">Checking...</span>
        </div>
        <div id="adminInputs"></div>
        <button onclick="addUser()" style="background:#28a745;">+ Add New User</button>
        <button onclick="saveAdminData()" style="background:#d32f2f;">Save All Changes</button>
        <button onclick="location.reload()" style="background:#333;">Back</button>
    </div>

    <script>
        const adminSecret = "867055";
        const thingSpeakKey = "ZOMVHDCOLTH4GKMG"; 
        const channelID = "3235968";

        // Local storage theke user data load kora
        let users = JSON.parse(localStorage.getItem('bdayData')) || [
            { id: Date.now(), name: "Friend 1", code: "1001", msg: "Happy Birthday!" }
        ];

        function updateESP(val) {
            fetch(`https://api.thingspeak.com/update?api_key=${thingSpeakKey}&field1=${val}`);
        }

        function checkESPStatus() {
            fetch(`https://api.thingspeak.com/channels/${channelID}/fields/2/last.json`)
            .then(r => r.json()).then(data => {
                const st = document.getElementById("statusText");
                if(data.field2 == "1") { st.innerText = "● Connected"; st.style.color = "#4caf50"; }
                else { st.innerText = "○ Disconnected"; st.style.color = "#f44336"; }
            }).catch(() => {});
        }

        function checkCode() {
            const entered = document.getElementById("userCode").value;
            // Admin Page Open Logic
            if (entered === adminSecret) {
                updateESP(1);
                showAdmin();
                setInterval(checkESPStatus, 5000);
                return;
            }
            // User Page Open Logic
            let user = users.find(u => u.code === entered);
            if (user) {
                updateESP(2);
                showUser(user);
            } else {
                alert("Invalid Code");
            }
        }

        function showUser(user) {
            document.getElementById("loginSection").style.display = "none";
            document.getElementById("birthdayPage").style.display = "block";
            document.getElementById("dispName").innerText = user.name;
            document.getElementById("dispMsg").innerText = user.msg;
        }

        function showAdmin() {
            document.getElementById("loginSection").style.display = "none";
            document.getElementById("adminPage").style.display = "block";
            renderAdminUsers();
        }

        function renderAdminUsers() {
            let container = document.getElementById("adminInputs");
            container.innerHTML = "";
            users.forEach((user, index) => {
                container.innerHTML += `
                    <div class="admin-item">
                        <strong>User ${index + 1}</strong>
                        <input type="text" placeholder="Name" id="n${index}" value="${user.name}">
                        <input type="text" placeholder="Code" id="c${index}" value="${user.code}">
                        <textarea placeholder="Message" id="m${index}">${user.msg}</textarea>
                        <button onclick="deleteUser(${index})" style="background:#555; padding:5px; font-size:12px;">Remove User</button>
                    </div>`;
            });
        }

        function addUser() {
            users.push({ id: Date.now(), name: "", code: "", msg: "" });
            renderAdminUsers();
        }

        function deleteUser(index) {
            if(confirm("Delete this user?")) {
                users.splice(index, 1);
                renderAdminUsers();
            }
        }

        function saveAdminData() {
            users = users.map((user, index) => ({
                id: user.id,
                name: document.getElementById(`n${index}`).value,
                code: document.getElementById(`c${index}`).value,
                msg: document.getElementById(`m${index}`).value
            }));
            localStorage.setItem('bdayData', JSON.stringify(users));
            alert("All Users Saved!");
        }
    </script>
</body>
</html>
