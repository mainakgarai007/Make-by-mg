<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Birthday Portal</title>
    <style>
        body { background: #0d0d0d; color: #ffffff; font-family: sans-serif; text-align: center; padding: 15px; }
        .card { background: #1a1a1a; padding: 20px; border-radius: 10px; border: 1px solid #333; margin: 15px auto; max-width: 400px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        input, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 5px; border: 1px solid #444; background: #262626; color: #fff; box-sizing: border-box; }
        button { background: #1a73e8; color: white; border: none; padding: 12px; width: 100%; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .chat-box { display: none; margin-top: 15px; border-top: 1px solid #333; padding-top: 15px; }
        #chatDisplay { height: 150px; overflow-y: scroll; background: #000; padding: 10px; border-radius: 5px; text-align: left; font-size: 13px; margin-bottom: 10px; border: 1px solid #444; }
        .msg-line { color: #4caf50; margin-bottom: 5px; }
        #birthdayPage, #adminPage { display: none; }
    </style>
</head>
<body>

    <div id="loginSection" class="card">
        <h2>Access Portal</h2>
        <input type="text" id="userCode" placeholder="Enter Code">
        <button onclick="checkCode()">Unlock</button>
    </div>

    <div id="birthdayPage" class="card">
        <h1 style="color:#4caf50;">Happy Birthday!</h1>
        <h2 id="dispName"></h2>
        <p id="dispMsg"></p>
        
        <button onclick="toggleChat()" style="background:#ff9800;">Open Group Chat</button>
        
        <div id="chatSection" class="chat-box">
            <div id="chatDisplay">Loading messages...</div>
            <input type="text" id="chatInput" placeholder="Type a message...">
            <button onclick="sendChatMessage()" style="background:#28a745;">Send Message</button>
        </div>
        
        <button onclick="location.reload()" style="background:#333; margin-top:20px;">Exit</button>
    </div>

    <div id="adminPage"> ... </div>

    <script>
        const thingSpeakKey = "ZOMVHDCOLTH4GKMG"; 
        const channelID = "3235968";
        let currentUserName = "";

        // Previous user logic and updateESP code here...

        function checkCode() {
            const entered = document.getElementById("userCode").value;
            // Admin logic...
            let user = users.find(u => u.code === entered);
            if (user) {
                currentUserName = user.name;
                updateESP(2); // Signal User Login
                showUser(user);
            }
            // ...
        }

        function showUser(user) {
            document.getElementById("loginSection").style.display = "none";
            document.getElementById("birthdayPage").style.display = "block";
            document.getElementById("dispName").innerText = user.name;
            document.getElementById("dispMsg").innerText = user.msg;
        }

        function toggleChat() {
            const chat = document.getElementById("chatSection");
            chat.style.display = chat.style.display === "none" ? "block" : "none";
            if(chat.style.display === "block") {
                loadChat();
                setInterval(loadChat, 5000); // 5s por por update hobe
            }
        }

        function sendChatMessage() {
            const msg = document.getElementById("chatInput").value;
            if(!msg) return;
            const fullMsg = encodeURIComponent(currentUserName + ": " + msg);
            fetch(`https://api.thingspeak.com/update?api_key=${thingSpeakKey}&field3=${fullMsg}`);
            document.getElementById("chatInput").value = "";
            setTimeout(loadChat, 2000);
        }

        function loadChat() {
            fetch(`https://api.thingspeak.com/channels/${channelID}/fields/3.json?results=5`)
            .then(r => r.json()).then(data => {
                const disp = document.getElementById("chatDisplay");
                disp.innerHTML = "";
                data.feeds.forEach(f => {
                    if(f.field3) {
                        disp.innerHTML += `<div class="msg-line">${f.field3}</div>`;
                    }
                });
                disp.scrollTop = disp.scrollHeight;
            });
        }
    </script>
</body>
</html>
